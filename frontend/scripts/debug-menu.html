<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èœå•è°ƒè¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            margin: 5px 0;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>ğŸ” H-System EDR èœå•è°ƒè¯•</h1>
    
    <div class="debug-card">
        <h2>ç¯å¢ƒæ£€æŸ¥</h2>
        <button onclick="checkEnvironment()">æ£€æŸ¥ç¯å¢ƒå˜é‡</button>
        <button onclick="checkVueApp()">æ£€æŸ¥Vueåº”ç”¨</button>
        <button onclick="checkStores()">æ£€æŸ¥StoreçŠ¶æ€</button>
        <div id="env-results"></div>
    </div>
    
    <div class="debug-card">
        <h2>è·¯ç”±åˆ†æ</h2>
        <button onclick="analyzeRoutes()">åˆ†æè·¯ç”±é…ç½®</button>
        <button onclick="checkMenuRoutes()">æ£€æŸ¥èœå•è·¯ç”±</button>
        <button onclick="testPermissions()">æµ‹è¯•æƒé™æ£€æŸ¥</button>
        <div id="route-results"></div>
    </div>
    
    <div class="debug-card">
        <h2>æƒé™è°ƒè¯•</h2>
        <button onclick="debugPermissions()">è°ƒè¯•æƒé™ç³»ç»Ÿ</button>
        <button onclick="simulateLogin()">æ¨¡æ‹Ÿç™»å½•</button>
        <div id="permission-results"></div>
    </div>

    <script>
        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `status ${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            container.appendChild(logEntry);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        async function checkEnvironment() {
            clearResults('env-results');
            log('env-results', 'ğŸ” æ£€æŸ¥ç¯å¢ƒå˜é‡...', 'info');
            
            try {
                // æ£€æŸ¥æ˜¯å¦åœ¨Vueåº”ç”¨ä¸­
                if (typeof window.Vue !== 'undefined' || typeof window.__VUE__ !== 'undefined') {
                    log('env-results', 'âœ… Vueç¯å¢ƒæ£€æµ‹æˆåŠŸ', 'success');
                } else {
                    log('env-results', 'âŒ æœªæ£€æµ‹åˆ°Vueç¯å¢ƒ', 'error');
                }
                
                // å°è¯•è®¿é—®ç¯å¢ƒå˜é‡ï¼ˆéœ€è¦åœ¨Vueåº”ç”¨ä¸­ï¼‰
                log('env-results', 'ğŸ’¡ è¯·åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤:', 'info');
                log('env-results', 'console.log("VITE_ENABLE_AUTH:", import.meta.env.VITE_ENABLE_AUTH)', 'info');
                
            } catch (error) {
                log('env-results', `âŒ ç¯å¢ƒæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkVueApp() {
            clearResults('env-results');
            log('env-results', 'ğŸ” æ£€æŸ¥Vueåº”ç”¨çŠ¶æ€...', 'info');
            
            try {
                // æ£€æŸ¥Vue DevTools
                if (window.__VUE_DEVTOOLS_GLOBAL_HOOK__) {
                    log('env-results', 'âœ… Vue DevToolså¯ç”¨', 'success');
                } else {
                    log('env-results', 'âš ï¸ Vue DevToolsä¸å¯ç”¨', 'warning');
                }
                
                log('env-results', 'ğŸ’¡ è¯·åœ¨ä¸»åº”ç”¨é¡µé¢çš„æ§åˆ¶å°ä¸­è¿è¡Œ:', 'info');
                log('env-results', '1. æ£€æŸ¥è·¯ç”±: console.log($router.getRoutes())', 'info');
                log('env-results', '2. æ£€æŸ¥ç”¨æˆ·store: console.log(useUserStore())', 'info');
                log('env-results', '3. æ£€æŸ¥åº”ç”¨store: console.log(useAppStore())', 'info');
                
            } catch (error) {
                log('env-results', `âŒ Vueåº”ç”¨æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function checkStores() {
            clearResults('env-results');
            log('env-results', 'ğŸ” æ£€æŸ¥StoreçŠ¶æ€...', 'info');
            
            log('env-results', 'ğŸ’¡ åœ¨ä¸»åº”ç”¨é¡µé¢æ§åˆ¶å°ä¸­è¿è¡Œä»¥ä¸‹ä»£ç :', 'info');
            
            const debugCode = `
// æ£€æŸ¥ç”¨æˆ·Store
const userStore = useUserStore();
console.log('ç”¨æˆ·Store:', userStore);
console.log('æ˜¯å¦ç™»å½•:', userStore.isLoggedIn);
console.log('ç”¨æˆ·æƒé™:', userStore.permissions);

// æµ‹è¯•æƒé™æ£€æŸ¥
console.log('æµ‹è¯•æƒé™ alert:read:', userStore.hasPermission('alert:read'));
console.log('æµ‹è¯•æƒé™ asset:read:', userStore.hasPermission('asset:read'));

// æ£€æŸ¥ç¯å¢ƒå˜é‡
console.log('è®¤è¯å¼€å…³:', import.meta.env.VITE_ENABLE_AUTH);
            `;
            
            log('env-results', debugCode, 'info');
        }

        async function analyzeRoutes() {
            clearResults('route-results');
            log('route-results', 'ğŸ” åˆ†æè·¯ç”±é…ç½®...', 'info');
            
            const routeAnalysisCode = `
// è·å–æ‰€æœ‰è·¯ç”±
const allRoutes = $router.getRoutes();
console.log('æ‰€æœ‰è·¯ç”±æ•°é‡:', allRoutes.length);

// æŸ¥æ‰¾Layoutè·¯ç”±
const layoutRoute = allRoutes.find(r => r.name === 'Layout');
console.log('Layoutè·¯ç”±:', layoutRoute);

// è·å–èœå•è·¯ç”±
const menuRoutes = layoutRoute?.children?.filter(route => !route.meta?.hideInMenu) || [];
console.log('èœå•è·¯ç”±æ•°é‡:', menuRoutes.length);
console.log('èœå•è·¯ç”±:', menuRoutes);

// åˆ†ææ¯ä¸ªèœå•è·¯ç”±çš„æƒé™
menuRoutes.forEach(route => {
    console.log(\`è·¯ç”± \${route.path}:\`, {
        title: route.meta?.title,
        permission: route.meta?.permission,
        hideInMenu: route.meta?.hideInMenu
    });
});
            `;
            
            log('route-results', 'ğŸ’¡ åœ¨ä¸»åº”ç”¨é¡µé¢æ§åˆ¶å°ä¸­è¿è¡Œ:', 'info');
            log('route-results', routeAnalysisCode, 'info');
        }

        async function checkMenuRoutes() {
            clearResults('route-results');
            log('route-results', 'ğŸ” æ£€æŸ¥èœå•è·¯ç”±è¿‡æ»¤...', 'info');
            
            const menuCheckCode = `
// æ¨¡æ‹ŸMainLayoutä¸­çš„èœå•è·¯ç”±è®¡ç®—
const router = useRouter();
const userStore = useUserStore();

// è·å–èœå•è·¯ç”±
const menuRoutes = router.getRoutes()
    .find(route => route.name === 'Layout')
    ?.children?.filter(route => !route.meta?.hideInMenu) || [];

console.log('åŸå§‹èœå•è·¯ç”±:', menuRoutes);

// æ¨¡æ‹Ÿæƒé™æ£€æŸ¥
const hasPermission = (permission) => {
    if (!permission) return true;
    
    const ENABLE_AUTH = import.meta.env.VITE_ENABLE_AUTH === 'true';
    if (!ENABLE_AUTH) return true;
    
    return userStore.hasPermission(permission);
};

// è¿‡æ»¤æœ‰æƒé™çš„è·¯ç”±
const visibleRoutes = menuRoutes.filter(route => hasPermission(route.meta?.permission));
console.log('å¯è§èœå•è·¯ç”±:', visibleRoutes);
console.log('å¯è§èœå•æ•°é‡:', visibleRoutes.length);
            `;
            
            log('route-results', 'ğŸ’¡ åœ¨ä¸»åº”ç”¨é¡µé¢æ§åˆ¶å°ä¸­è¿è¡Œ:', 'info');
            log('route-results', menuCheckCode, 'info');
        }

        async function testPermissions() {
            clearResults('route-results');
            log('route-results', 'ğŸ” æµ‹è¯•æƒé™æ£€æŸ¥å‡½æ•°...', 'info');
            
            const permissionTestCode = `
// æµ‹è¯•æƒé™æ£€æŸ¥
const userStore = useUserStore();

// æµ‹è¯•å„ç§æƒé™
const permissions = ['alert:read', 'asset:read', 'hunting:read', 'intelligence:read', 'investigation:read', 'report:read', 'system:read'];

console.log('ç¯å¢ƒå˜é‡ VITE_ENABLE_AUTH:', import.meta.env.VITE_ENABLE_AUTH);

permissions.forEach(perm => {
    const hasPermission = userStore.hasPermission(perm);
    console.log(\`æƒé™ \${perm}: \${hasPermission}\`);
});

// æµ‹è¯•æ— æƒé™è¦æ±‚çš„æƒ…å†µ
console.log('æ— æƒé™è¦æ±‚:', userStore.hasPermission(undefined));
console.log('ç©ºå­—ç¬¦ä¸²æƒé™:', userStore.hasPermission(''));
            `;
            
            log('route-results', 'ğŸ’¡ åœ¨ä¸»åº”ç”¨é¡µé¢æ§åˆ¶å°ä¸­è¿è¡Œ:', 'info');
            log('route-results', permissionTestCode, 'info');
        }

        async function debugPermissions() {
            clearResults('permission-results');
            log('permission-results', 'ğŸ” è°ƒè¯•æƒé™ç³»ç»Ÿ...', 'info');
            
            log('permission-results', 'ğŸ“‹ æƒé™è°ƒè¯•æ­¥éª¤:', 'info');
            log('permission-results', '1. ç¡®è®¤ VITE_ENABLE_AUTH=false', 'info');
            log('permission-results', '2. æ£€æŸ¥ userStore.hasPermission æ–¹æ³•', 'info');
            log('permission-results', '3. æ£€æŸ¥ MainLayout.vue ä¸­çš„ hasPermission å‡½æ•°', 'info');
            log('permission-results', '4. éªŒè¯èœå•è¿‡æ»¤é€»è¾‘', 'info');
            
            const fullDebugCode = `
// å®Œæ•´çš„æƒé™è°ƒè¯•
console.log('=== æƒé™ç³»ç»Ÿè°ƒè¯• ===');

// 1. ç¯å¢ƒæ£€æŸ¥
console.log('1. ç¯å¢ƒå˜é‡:');
console.log('   VITE_ENABLE_AUTH:', import.meta.env.VITE_ENABLE_AUTH);

// 2. Storeæ£€æŸ¥
const userStore = useUserStore();
console.log('2. ç”¨æˆ·Store:');
console.log('   isLoggedIn:', userStore.isLoggedIn);
console.log('   permissions:', userStore.permissions);
console.log('   hasPermissionæ–¹æ³•:', typeof userStore.hasPermission);

// 3. æƒé™æµ‹è¯•
console.log('3. æƒé™æµ‹è¯•:');
const testPermissions = ['alert:read', 'asset:read', 'hunting:read'];
testPermissions.forEach(perm => {
    console.log(\`   \${perm}: \${userStore.hasPermission(perm)}\`);
});

// 4. èœå•è·¯ç”±æ£€æŸ¥
console.log('4. èœå•è·¯ç”±:');
const router = useRouter();
const layoutRoute = router.getRoutes().find(r => r.name === 'Layout');
const menuRoutes = layoutRoute?.children?.filter(r => !r.meta?.hideInMenu) || [];
console.log('   èœå•è·¯ç”±æ•°é‡:', menuRoutes.length);
menuRoutes.forEach(route => {
    const hasPermission = !route.meta?.permission || userStore.hasPermission(route.meta.permission);
    console.log(\`   \${route.path} (\${route.meta?.title}): \${hasPermission}\`);
});
            `;
            
            log('permission-results', 'ğŸ’¡ åœ¨ä¸»åº”ç”¨é¡µé¢æ§åˆ¶å°ä¸­è¿è¡Œå®Œæ•´è°ƒè¯•:', 'info');
            log('permission-results', fullDebugCode, 'info');
        }

        async function simulateLogin() {
            clearResults('permission-results');
            log('permission-results', 'ğŸ” æ¨¡æ‹Ÿç™»å½•çŠ¶æ€...', 'info');
            
            const loginSimulationCode = `
// æ¨¡æ‹Ÿç™»å½•çŠ¶æ€
const userStore = useUserStore();

// è®¾ç½®æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®
userStore.user = {
    id: 1,
    username: 'admin',
    email: 'admin@hsystem.com',
    fullName: 'ç³»ç»Ÿç®¡ç†å‘˜',
    avatar: '',
    roles: [
        {
            id: 1,
            name: 'admin',
            displayName: 'ç®¡ç†å‘˜'
        }
    ]
};

// è®¾ç½®æ‰€æœ‰æƒé™
userStore.permissions = [
    'alert:read', 'alert:write', 'alert:delete',
    'asset:read', 'asset:write', 'asset:delete',
    'hunting:read', 'hunting:write', 'hunting:delete',
    'intelligence:read', 'intelligence:write', 'intelligence:delete',
    'investigation:read', 'investigation:write', 'investigation:delete',
    'report:read', 'report:write', 'report:delete',
    'system:read', 'system:write', 'system:delete',
    'user:read', 'user:write', 'user:delete'
];

console.log('æ¨¡æ‹Ÿç™»å½•å®Œæˆ');
console.log('ç”¨æˆ·:', userStore.user);
console.log('æƒé™:', userStore.permissions);
console.log('ç°åœ¨åˆ·æ–°é¡µé¢æŸ¥çœ‹èœå•');
            `;
            
            log('permission-results', 'ğŸ’¡ åœ¨ä¸»åº”ç”¨é¡µé¢æ§åˆ¶å°ä¸­è¿è¡Œ:', 'info');
            log('permission-results', loginSimulationCode, 'info');
            log('permission-results', 'âš ï¸ æ³¨æ„ï¼šè¿è¡Œåéœ€è¦åˆ·æ–°é¡µé¢æ‰èƒ½çœ‹åˆ°æ•ˆæœ', 'warning');
        }

        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        window.onload = function() {
            log('env-results', 'ğŸ“„ èœå•è°ƒè¯•é¡µé¢å·²åŠ è½½', 'success');
            log('env-results', 'ğŸ’¡ è¯·å…ˆåœ¨ä¸»åº”ç”¨é¡µé¢ (http://192.168.100.123:3000) æ‰“å¼€å¼€å‘è€…å·¥å…·', 'info');
            log('env-results', 'ç„¶åä½¿ç”¨æ­¤é¡µé¢çš„æŒ‰é’®ç”Ÿæˆè°ƒè¯•ä»£ç ', 'info');
        };
    </script>
</body>
</html>
