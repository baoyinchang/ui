<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>报告中心 - H-System EDR平台</title>
    <style>
        /* 基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }

        body {
            display: flex;
            height: 100vh;
            overflow: hidden;
            background-color: #f5f7fa;
        }

        /* 左侧菜单栏 */
        .sidebar {
            width: 220px;
            background-color: #2c3e50;
            color: white;
            height: 100%;
            transition: all 0.3s;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #34495e;
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            border-left: 3px solid transparent;
            text-decoration: none;
            color: white;
            position: relative;
        }

        .menu-item:hover {
            background-color: #34495e;
        }

        .menu-item.active {
            background-color: #34495e;
            border-left-color: #3498db;
        }

        .menu-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* 右侧主内容区 */
        .main-container {
            flex: 1;
            min-width: 0;
            width: calc(100% - 220px);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .top-bar {
            height: 60px;
            background-color: white;
            border-bottom: 1px solid #ecf_START_OF_SOMETHING_UNEXPECTED
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .breadcrumbs {
            color: #666;
            font-size: 14px;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-info img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            margin-right: 10px;
            background-color: #ecf_START_OF_SOMETHING_UNEXPECTED
        }

        .content-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f5f7fa;
        }

        /* 页面通用样式 */
        .page-title {
            font-size: 22px;
            margin-bottom: 20px;
            color: #2c3e50;
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .page-title i {
            margin-right: 10px;
            color: #3498db;
        }
        
        .page-description {
            color: #666;
            margin-bottom: 25px;
            padding-left: 32px;
        }

        .card {
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid #ecf_START_OF_SOMETHING_UNEXPECTED
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }
        
        .card-title i {
            margin-right: 8px;
            color: #3498db;
        }

        .card-actions {
            display: flex;
            gap: 10px;
        }

        /* 报表筛选区 */
        .report-filters {
            background-color: #f8fafc;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        /* 按钮样式 */
        .btn {
            padding: 6px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn .fas.fa-spin {
            animation: fa-spin 1s infinite linear;
        }
        @keyframes fa-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #218838;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid #3498db;
            color: #3498db;
        }

        .btn-outline:hover:not(:disabled) {
            background-color: #3498db;
            color: white;
        }

        /* 报表预览区 */
        .report-preview-container {
            position: relative;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .report-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        
        .meta-item {
            flex: 1;
            min-width: 200px;
        }
        
        .meta-label {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 3px;
        }
        
        .meta-value {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }

        /* 报表列表样式 */
        .report-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .report-item {
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
            border-top: 3px solid #3498db;
            cursor: pointer;
        }
        
        .report-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .report-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .report-item-title {
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }
        
        .report-item-title i {
            margin-right: 8px;
            color: #3498db;
        }

        .report-item-desc {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .report-item-meta {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
        }

        .report-item-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 10px;
        }

        /* 导出选项弹窗 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: 6px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #ecf_START_OF_SOMETHING_UNEXPECTED
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #ecf_START_OF_SOMETHING_UNEXPECTED
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .export-option {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f1f3f5;
        }
        
        .export-option:last-child {
            border-bottom: none;
        }
        
        .export-option input {
            margin-right: 10px;
        }
        
        .export-option label {
            flex: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-option i {
            color: #6c757d;
        }

        /* 通知提示 */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            z-index: 9999;
            animation: fadeIn 0.3s, fadeOut 0.3s 3.7s;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }

        /* 标签样式 */
        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .tag-success {
            background-color: #dcfce7;
            color: #166534;
        }
        .tag-generating {
            background-color: #dbeafe;
            color: #1e40af;
        }

    </style>
    <!-- 引入Font Awesome图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- 引入Chart.js用于图表展示 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
</head>
<body>
    <!-- 左侧菜单栏 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>H-System EDR平台</h1>
        </div>
        <div class="menu-list">
            <a href="index.html" class="menu-item">
                <i class="fas fa-tachometer-alt"></i>
                <span>安全态势</span>
            </a>
            <a href="alert-center.html" class="menu-item">
                <i class="fas fa-exclamation-triangle"></i>
                <span>告警中心</span>
            </a>
            <a href="investigation.html" class="menu-item">
                <i class="fas fa-search"></i>
                <span>调查与响应</span>
            </a>
            <a href="asset-management.html" class="menu-item">
                <i class="fas fa-desktop"></i>
                <span>资产管理</span>
            </a>
            <a href="threat-hunting.html" class="menu-item">
                <i class="fas fa-crosshairs"></i>
                <span>威胁狩猎</span>
            </a>
            <a href="threat-intelligence.html" class="menu-item">
                <i class="fas fa-shield-alt"></i>
                <span>威胁情报</span>
            </a>
            <a href="report-center.html" class="menu-item active">
                <i class="fas fa-file-alt"></i>
                <span>报告中心</span>
            </a>
            <a href="system-management.html" class="menu-item">
                <i class="fas fa-cog"></i>
                <span>系统管理</span>
            </a>
        </div>
    </div>

    <!-- 右侧主内容区 -->
    <div class="main-container">
        <div class="top-bar">
            <div class="breadcrumbs">当前位置: 首页 > 报告中心</div>
            <div class="user-info">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='30' r='20' fill='%233498db'/%3E%3Cpath d='M10,90 C10,65 30,55 50,55 C70,55 90,65 90,90' fill='%233498db'/%3E%3C/svg%3E" alt="用户头像">
                <span>安全分析师</span>
            </div>
        </div>

        <div class="content-area">
            <h2 class="page-title">
                <i class="fas fa-file-alt"></i>报告中心 <span style="font-size: 14px; font-weight: normal; color: #666; margin-left: 10px;">Security Reports</span>
            </h2>
            <p class="page-description">
                实时预览、生成和订阅各类安全报表，包括告警趋势分析、事件处理SLA统计和资产健康度评估等。
            </p>

            <!-- 报表筛选区 -->
            <div class="report-filters">
                <div class="filter-group">
                    <label for="reportType">报表类型</label>
                    <select id="reportType" class="form-control">
                        <option value="alert-trend">告警趋势报表</option>
                        <option value="sla">事件处理SLA报表</option>
                        <option value="asset-health">资产健康度报表</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="timeRange">时间范围</label>
                    <select id="timeRange" class="form-control">
                        <option value="7">近7天</option>
                        <option value="30" selected>近30天</option>
                        <option value="90">近90天</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="assetGroup">资产组</label>
                    <select id="assetGroup" class="form-control">
                        <option value="all">全部资产</option>
                        <option value="server">服务器</option>
                        <option value="workstation">工作站</option>
                        <option value="network">网络设备</option>
                    </select>
                </div>
                <div class="filter-group" style="align-self: flex-end;">
                    <button class="btn btn-primary" id="saveReportBtn">
                        <i class="fas fa-save"></i> 保存为报表
                    </button>
                </div>
            </div>

            <!-- 报表预览区 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-chart-line"></i>报表预览
                    </h3>
                    <div class="card-actions">
                        <button class="btn btn-secondary" onclick="scheduleReport()">
                            <i class="fas fa-clock"></i> 设置计划任务
                        </button>
                        <button class="btn btn-success" onclick="showExportOptions()">
                            <i class="fas fa-download"></i> 导出报表
                        </button>
                    </div>
                </div>
                <div class="report-preview-container">
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="chart-container">
                        <canvas id="reportChart"></canvas>
                    </div>
                </div>
                
                <div class="report-meta">
                    <div class="meta-item">
                        <div class="meta-label">报表预览时间</div>
                        <div class="meta-value" id="meta-preview-time">-</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">时间范围</div>
                        <div class="meta-value" id="meta-time-range">-</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">包含资产数</div>
                        <div class="meta-value" id="meta-asset-count">-</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">数据更新于</div>
                        <div class="meta-value" id="meta-data-update">-</div>
                    </div>
                </div>
            </div>

            <!-- 常用报表模板 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-th-large"></i>常用报表模板
                    </h3>
                </div>
                <div class="report-list">
                    <div class="report-item" data-report-type="alert-trend">
                        <div class="report-item-title"><i class="fas fa-chart-bar"></i>告警趋势报表</div>
                        <div class="report-item-desc">分析告警数量变化、类型分布和处理情况，帮助识别安全事件模式。</div>
                    </div>
                    <div class="report-item" data-report-type="sla">
                        <div class="report-item-title"><i class="fas fa-tasks"></i>事件处理SLA报表</div>
                        <div class="report-item-desc">统计安全事件的响应时间、处理时长和SLA达标率，评估团队响应效率。</div>
                    </div>
                    <div class="report-item" data-report-type="asset-health">
                        <div class="report-item-title"><i class="fas fa-heartbeat"></i>资产健康度报表</div>
                        <div class="report-item-desc">评估资产的安全健康状态，包括漏洞数量、补丁状态、防护覆盖率等。</div>
                    </div>
                </div>
            </div>

            <!-- 最近生成的报表 -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-history"></i>最近生成的报表
                    </h3>
                </div>
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>报表名称</th>
                                <th>类型</th>
                                <th>生成时间</th>
                                <th>生成人</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="recentReportsTableBody">
                            <!-- 动态添加 -->
                        </tbody>
                        
                        <tbody>
                            <tr>
                                <td>2023年Q3安全告警趋势分析</td>
                                <td>告警趋势报表</td>
                                <td>2023-10-15 09:23</td>
                                <td>安全分析师</td>
                                <td><span class="tag tag-success">已完成</span></td>
                                <td class="table-actions">
                                    <button class="btn btn-sm btn-outline" onclick="showToast('正在加载报表...')">查看</button>
                                    <button class="btn btn-sm btn-primary" onclick="showExportOptions()">下载</button>
                                </td>
                            </tr>
                            <tr>
                                <td>9月资产健康度评估报告</td>
                                <td>资产健康度报表</td>
                                <td>2023-10-01 14:56</td>
                                <td>安全管理员</td>
                                <td><span class="tag tag-success">已完成</span></td>
                                <td class="table-actions">
                                    <button class="btn btn-sm btn-outline" onclick="showToast('正在加载报表...')">查看</button>
                                    <button class="btn btn-sm btn-primary" onclick="showExportOptions()">下载</button>
                                </td>
                            </tr>
                            <tr>
                                <td>安全事件处理SLA月度审计</td>
                                <td>事件处理SLA报表</td>
                                <td>2023-09-30 16:42</td>
                                <td>安全主管</td>
                                <td><span class="tag tag-success">已完成</span></td>
                                <td class="table-actions">
                                    <button class="btn btn-sm btn-outline" onclick="showToast('正在加载报表...')">查看</button>
                                    <button class="btn btn-sm btn-primary" onclick="showExportOptions()">下载</button>
                                </td>
                            </tr>
                        </tbody>
                        
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 导出选项弹窗 -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>导出报表</h3>
                <button class="modal-close" onclick="closeExportOptions()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #666;">请选择导出格式和选项：</p>
                <div class="export-option">
                    <input type="radio" name="exportFormat" id="pdfFormat" value="PDF" checked>
                    <label for="pdfFormat"><i class="fas fa-file-pdf"></i> PDF格式</label>
                </div>
                <div class="export-option">
                    <input type="radio" name="exportFormat" id="excelFormat" value="Excel">
                    <label for="excelFormat"><i class="fas fa-file-excel"></i> Excel格式</label>
                </div>
                <div class="export-option">
                    <input type="radio" name="exportFormat" id="csvFormat" value="CSV">
                    <label for="csvFormat"><i class="fas fa-file-csv"></i> CSV格式</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeExportOptions()">取消</button>
                <button class="btn btn-success" onclick="confirmExport()">确认导出</button>
            </div>
        </div>
    </div>

    <script>
        // --- 全局变量和配置 ---
        let reportChart;
        const reportConfigs = {
            'alert-trend': {
                name: '告警趋势报表',
                chartType: 'line',
                dataFunc: (days) => {
                    const labels = Array.from({ length: days }, (_, i) => dayjs().subtract(days - 1 - i, 'day').format('MM/DD'));
                    return {
                        labels,
                        datasets: [
                            { label: '高危告警', data: generateRandomData(days, 5, 20), borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.1)', tension: 0.3, fill: true },
                            { label: '中危告警', data: generateRandomData(days, 20, 40), borderColor: '#f39c12', backgroundColor: 'rgba(243, 156, 18, 0.1)', tension: 0.3, fill: true },
                            { label: '低危告警', data: generateRandomData(days, 40, 70), borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', tension: 0.3, fill: true }
                        ]
                    };
                },
                options: {
                    scales: { y: { beginAtZero: true, title: { display: true, text: '告警数量' } }, x: { title: { display: true, text: '日期' } } }
                }
            },
            'sla': {
                name: '事件处理SLA报表',
                chartType: 'bar',
                dataFunc: () => ({
                    labels: ['紧急', '高危', '中危', '低危'],
                    datasets: [
                        { label: '平均响应时间(分钟)', data: [15, 45, 120, 240], backgroundColor: 'rgba(52, 152, 219, 0.7)' },
                        { label: 'SLA要求(分钟)', data: [30, 60, 180, 360], backgroundColor: 'rgba(46, 204, 113, 0.7)' }
                    ]
                }),
                options: {
                    scales: { y: { beginAtZero: true, title: { display: true, text: '时间（分钟）' } }, x: { title: { display: true, text: '事件优先级' } } }
                }
            },
            'asset-health': {
                name: '资产健康度报表',
                chartType: 'bar',
                dataFunc: () => ({
                    labels: ['服务器', '工作站', '网络设备', 'IoT设备'],
                    datasets: [
                        { label: '健康资产', data: generateRandomData(4, 50, 200), backgroundColor: '#2ecc71' },
                        { label: '需关注', data: generateRandomData(4, 10, 40), backgroundColor: '#f39c12' },
                        { label: '高风险', data: generateRandomData(4, 2, 15), backgroundColor: '#e74c3c' }
                    ]
                }),
                options: {
                    scales: { x: { stacked: true, title: { display: true, text: '资产类型' } }, y: { stacked: true, title: { display: true, text: '资产数量' } } }
                }
            }
        };

        // --- DOM 元素 ---
        const reportTypeSelect = document.getElementById('reportType');
        const timeRangeSelect = document.getElementById('timeRange');
        const assetGroupSelect = document.getElementById('assetGroup');
        const saveReportBtn = document.getElementById('saveReportBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const recentReportsTableBody = document.getElementById('recentReportsTableBody');

        // --- 事件监听 ---
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化页面
            generateReportPreview();

            // 绑定筛选条件变化事件
            [reportTypeSelect, timeRangeSelect, assetGroupSelect].forEach(el => {
                el.addEventListener('change', generateReportPreview);
            });

            // 绑定保存报表按钮事件
            saveReportBtn.addEventListener('click', saveReport);

            // 绑定模板卡片点击事件
            document.querySelectorAll('.report-item').forEach(item => {
                item.addEventListener('click', () => {
                    const reportType = item.getAttribute('data-report-type');
                    reportTypeSelect.value = reportType;
                    generateReportPreview();
                    showToast(`已加载 ${reportConfigs[reportType].name} 模板`);
                });
            });
        });

        // ---核心功能函数 ---

        /**
         * 生成报表预览
         */
        function generateReportPreview() {
            setLoadingState(true);
            const reportType = reportTypeSelect.value;
            const config = reportConfigs[reportType];
            
            // 模拟网络延迟
            setTimeout(() => {
                updateChart(config);
                updateReportMeta();
                setLoadingState(false);
            }, 1200);
        }

        /**
         * 更新图表
         * @param {object} config - 报表配置
         */
        function updateChart(config) {
            const ctx = document.getElementById('reportChart').getContext('2d');
            if (reportChart) {
                reportChart.destroy();
            }
            
            const timeRange = parseInt(timeRangeSelect.value);
            const chartData = config.dataFunc(timeRange);
            const titleText = `${config.name} (${getTimeRangeText(timeRange)})`;

            reportChart = new Chart(ctx, {
                type: config.chartType,
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: true, text: titleText, font: { size: 16 } },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    ...config.options
                }
            });
        }

        /**
         * 更新报表元数据
         */
        function updateReportMeta() {
            const timeRange = parseInt(timeRangeSelect.value);
            document.getElementById('meta-preview-time').textContent = getCurrentDateTime();
            document.getElementById('meta-time-range').textContent = `${dayjs().subtract(timeRange - 1, 'day').format('YYYY-MM-DD')} 至 ${dayjs().format('YYYY-MM-DD')}`;
            document.getElementById('meta-asset-count').textContent = `${generateRandomData(1, 150, 300)[0]} 台`;
            document.getElementById('meta-data-update').textContent = `${generateRandomData(1, 1, 10)[0]} 分钟前`;
        }

        /**
         * 保存报表到历史记录
         */
        function saveReport() {
            const reportType = reportTypeSelect.value;
            const timeRange = parseInt(timeRangeSelect.value);
            const reportName = `${dayjs().format('YYYY-MM-DD')} ${reportConfigs[reportType].name} (${getTimeRangeText(timeRange)})`;

            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${reportName}</td>
                <td>${reportConfigs[reportType].name}</td>
                <td>${getCurrentDateTime()}</td>
                <td>安全分析师</td>
                <td><span class="tag tag-success">已完成</span></td>
                <td class="table-actions">
                    <button class="btn btn-sm btn-outline" onclick="showToast('正在加载报表...')">查看</button>
                    <button class="btn btn-sm btn-primary" onclick="showExportOptions()">下载</button>
                </td>
            `;
            recentReportsTableBody.prepend(newRow);
            showToast('报表已成功保存！');
        }

        /**
         * 设置加载状态
         * @param {boolean} isLoading - 是否正在加载
         */
        function setLoadingState(isLoading) {
            if (isLoading) {
                loadingOverlay.classList.add('active');
                [reportTypeSelect, timeRangeSelect, assetGroupSelect, saveReportBtn].forEach(el => el.disabled = true);
            } else {
                loadingOverlay.classList.remove('active');
                [reportTypeSelect, timeRangeSelect, assetGroupSelect, saveReportBtn].forEach(el => el.disabled = false);
            }
        }

        /**
         * 显示导出选项弹窗
         */
        function showExportOptions() {
            document.getElementById('exportModal').classList.add('active');
        }

        /**
         * 关闭导出选项弹窗
         */
        function closeExportOptions() {
            document.getElementById('exportModal').classList.remove('active');
        }

        /**
         * 确认导出
         */
        function confirmExport() {
            const format = document.querySelector('input[name="exportFormat"]:checked').value;
            closeExportOptions();
            showToast(`报表正在导出为 ${format} 格式...`, 'success');
            setTimeout(() => {
                showToast(`报表已成功导出为 ${format} 格式`);
            }, 1500);
        }
        
        /**
         * 计划任务占位符
         */
        function scheduleReport() {
            showToast('设置计划任务功能正在开发中...', 'info');
        }


        // --- 辅助函数 ---
        function generateRandomData(count, min, max) {
            return Array.from({ length: count }, () => Math.floor(Math.random() * (max - min + 1)) + min);
        }
        function getCurrentDateTime() {
            return dayjs().format('YYYY-MM-DD HH:mm:ss');
        }
        function getTimeRangeText(days) {
            return `近${days}天`;
        }
        function showToast(message, type = 'info') {
            const iconMap = {
                info: 'fa-info-circle',
                success: 'fa-check-circle',
                error: 'fa-times-circle'
            };
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i class="fas ${iconMap[type]}"></i> ${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
    </script>
</body>
</html>
