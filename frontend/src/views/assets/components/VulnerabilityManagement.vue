<template>
  <div class="vulnerability-management">
    <!-- 统计卡片 -->
    <el-row :gutter="20" class="stat-row">
      <el-col :span="4.8">
        <el-card class="stat-card critical">
          <div class="stat-value">{{ vulnerabilityData.filter(v => v.severity === 'critical').length }}</div>
          <div class="stat-label">严重漏洞</div>
        </el-card>
      </el-col>
      <el-col :span="4.8">
        <el-card class="stat-card high">
          <div class="stat-value">{{ vulnerabilityData.filter(v => v.severity === 'high').length }}</div>
          <div class="stat-label">高危漏洞</div>
        </el-card>
      </el-col>
      <el-col :span="4.8">
        <el-card class="stat-card medium">
          <div class="stat-value">{{ vulnerabilityData.filter(v => v.severity === 'medium').length }}</div>
          <div class="stat-label">中危漏洞</div>
        </el-card>
      </el-col>
      <el-col :span="4.8">
        <el-card class="stat-card">
          <div class="stat-value">{{ [...new Set(vulnerabilityData.map(v => v.affected))].length }}</div>
          <div class="stat-label">受影响主机</div>
        </el-card>
      </el-col>
      <el-col :span="4.8">
        <el-card class="stat-card">
          <div class="stat-value">{{ vulnerabilityData.filter(v => v.status !== '已修复').length }}</div>
          <div class="stat-label">关键补丁缺失</div>
        </el-card>
      </el-col>
    </el-row>

    <!-- 图表区域 -->
    <el-row :gutter="20" class="chart-row">
      <el-col :span="8">
        <el-card>
          <template #header>漏洞严重程度分布</template>
          <div class="chart-container">
            <el-loading v-if="loading" target=".chart-container" fullscreen="false" />
            <canvas id="vulnSeverityChart"></canvas>
          </div>
        </el-card>
      </el-col>
      <el-col :span="16">
        <el-card>
          <template #header>漏洞趋势</template>
          <div class="chart-container">
            <el-loading v-if="loading" target=".chart-container" fullscreen="false" />
            <canvas id="vulnTrendChart"></canvas>
          </div>
        </el-card>
      </el-col>
    </el-row>

    <!-- 漏洞列表 -->
    <el-card class="table-card">
      <template #header>漏洞列表</template>
      <el-table 
        v-loading="loading"
        :data="filteredVulnerabilities" 
        border 
        stripe
        style="width: 100%"
      >
        <el-table-column prop="cve" label="CVE ID" />
        <el-table-column prop="desc" label="描述" width="300" />
        <el-table-column prop="cvss" label="CVSS评分" />
        <el-table-column prop="severity" label="严重性">
          <template #default="scope">
            <el-tag 
              :type="severityTypeMap[scope.row.severity]"
              :class="`severity-${scope.row.severity}`"
            >
              {{ severityTextMap[scope.row.severity] }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="affected" label="受影响资产" />
        <el-table-column prop="firstSeen" label="首次发现" />
        <el-table-column prop="status" label="状态">
          <template #default="scope">
            <el-tag 
              :type="statusTypeMap[scope.row.status]"
            >
              {{ scope.row.status }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column label="操作" width="160">
          <template #default="scope">
            <el-button 
              type="text" 
              @click="handleViewVulnDetail(scope.row.cve)"
            >
              详情
            </el-button>
            <el-button 
              type="text" 
              @click="handleApplyPatch(scope.row.cve)"
              v-if="scope.row.status !== '已修复'"
            >
              修复
            </el-button>
          </template>
        </el-table-column>
      </el-table>

      <!-- 分页 -->
      <el-pagination
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
        :current-page="pagination.currentPage"
        :page-sizes="[10, 20, 50, 100]"
        :page-size="pagination.pageSize"
        :total="filteredVulnerabilities.length"
        layout="total, sizes, prev, pager, next, jumper"
        class="pagination"
      />
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, watch, computed } from 'vue'
import { ElMessage } from 'element-plus'
import Chart from 'chart.js/auto'

// 接收父组件参数
const props = defineProps({
  loading: { type: Boolean, default: false },
  vulnerabilityData: { type: Array, default: () => [] },
  vulnSeverityData: { type: Object, default: () => ({}) },
  vulnTrendData: { type: Object, default: () => ({}) }
})

// 图表实例
let vulnSeverityChart = null
let vulnTrendChart = null

// 筛选表单
const filterForm = ref({
  severity: '',
  status: '',
  keyword: ''
})

// 分页配置
const pagination = ref({
  currentPage: 1,
  pageSize: 10
})

// 严重性映射
const severityTextMap = {
  critical: '严重',
  high: '高危',
  medium: '中危',
  low: '低危'
}

const severityTypeMap = {
  critical: 'danger',
  high: 'warning',
  medium: 'info',
  low: 'success'
}

// 状态映射
const statusTypeMap = {
  '新发现': 'danger',
  '处理中': 'warning',
  '已修复': 'success'
}

// 筛选后的漏洞列表
const filteredVulnerabilities = computed(() => {
  return props.vulnerabilityData.filter(vuln => {
    // 严重性筛选
    if (filterForm.value.severity && vuln.severity !== filterForm.value.severity) {
      return false
    }
    // 状态筛选
    if (filterForm.value.status && vuln.status !== filterForm.value.status) {
      return false
    }
    // 关键词筛选
    if (filterForm.value.keyword) {
      const keyword = filterForm.value.keyword.toLowerCase()
      if (
        !vuln.cve.toLowerCase().includes(keyword) &&
        !vuln.desc.toLowerCase().includes(keyword)
      ) {
        return false
      }
    }
    return true
  })
})

// 查看漏洞详情
const handleViewVulnDetail = (cveId) => {
  ElMessage.info(`查看漏洞 ${cveId} 的详情`)
}

// 应用补丁
const handleApplyPatch = (cveId) => {
  ElMessage.success(`开始修复漏洞 ${cveId}`)
}

// 分页处理
const handleSizeChange = (size) => {
  pagination.value.pageSize = size
}

const handleCurrentChange = (page) => {
  pagination.value.currentPage = page
}

// 初始化图表
const initCharts = () => {
  // 漏洞严重程度图表
  const severityCtx = document.getElementById('vulnSeverityChart').getContext('2d')
  if (vulnSeverityChart) {
    vulnSeverityChart.destroy()
  }
  vulnSeverityChart = new Chart(severityCtx, {
    type: 'pie',
    data: {
      labels: Object.keys(props.vulnSeverityData).map(key => severityTextMap[key]),
      datasets: [{
        data: Object.values(props.vulnSeverityData),
        backgroundColor: [
          '#e74c3c', '#f39c12', '#3498db', '#2ecc71'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right'
        }
      }
    }
  })

  // 漏洞趋势图表
  const trendCtx = document.getElementById('vulnTrendChart').getContext('2d')
  if (vulnTrendChart) {
    vulnTrendChart.destroy()
  }
  vulnTrendChart = new Chart(trendCtx, {
    type: 'line',
    data: {
      labels: Object.keys(props.vulnTrendData),
      datasets: [{
        label: '新增漏洞数',
        data: Object.values(props.vulnTrendData),
        borderColor: '#3498db',
        backgroundColor: 'rgba(52, 152, 219, 0.1)',
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            precision: 0
          }
        }
      }
    }
  })
}

// 监听数据变化，重新渲染图表
watch([() => props.vulnSeverityData, () => props.vulnTrendData], () => {
  if (Object.keys(props.vulnSeverityData).length > 0) {
    initCharts()
  }
})

// 组件挂载时初始化图表
onMounted(() => {
  if (Object.keys(props.vulnSeverityData).length > 0) {
    initCharts()
  }
})

// 组件卸载时销毁图表
onUnmounted(() => {
  if (vulnSeverityChart) {
    vulnSeverityChart.destroy()
  }
  if (vulnTrendChart) {
    vulnTrendChart.destroy()
  }
})
</script>

<style scoped>
.vulnerability-management {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.stat-row {
  margin-bottom: 10px;
}

.stat-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px 0;
  height: 100%;
}

.stat-value {
  font-size: 28px;
  font-weight: bold;
  margin-bottom: 5px;
}

.stat-label {
  font-size: 14px;
  color: #6c757d;
}

.stat-card.critical .stat-value {
  color: #c0392b;
}

.stat-card.high .stat-value {
  color: #e74c3c;
}

.stat-card.medium .stat-value {
  color: #f39c12;
}

.chart-row {
  margin-bottom: 10px;
}

.chart-container {
  width: 100%;
  height: 300px;
  position: relative;
}

.table-card {
  margin-bottom: 10px;
}

.pagination {
  margin-top: 15px;
  text-align: right;
}

.severity-critical {
  background-color: #c0392b !important;
  color: white !important;
}

.severity-high {
  background-color: #e74c3c !important;
  color: white !important;
}

.severity-medium {
  background-color: #f39c12 !important;
  color: white !important;
}
</style>